<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Control Center</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        h1 { color: #1c1e21; }
        .card { background-color: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; margin-bottom: 4px; color: #606770; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #dddfe2; border-radius: 6px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        button:hover { background-color: #166fe5; }
        .suggestion-btn { background-color: #e7f3ff; color: #1877f2; border: 1px solid #1877f2; padding: 8px 12px; margin-right: 8px; margin-bottom: 8px; cursor: pointer; }
        .suggestion-btn:hover { background-color: #dcebff; }
        #suggestions-container { margin-top: 12px; }
        .settings-link { float: right; color: #606770; text-decoration: none; font-weight: 600; }
        .settings-link:hover { text-decoration: underline; }
        
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-online { background-color: #42b72a; }
        .status-offline { background-color: #ccc; }
        .account-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        .message { border: 1px solid #e0e0e0; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        .message-meta { font-size: 0.85em; color: #606770; margin-bottom: 4px; }
        .message .text { font-size: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/settings" class="settings-link">âš™ Settings</a>
        <h1>WhatsApp Control Center</h1>

        <div class="card">
            <h2>Account Status</h2>
            <div id="account-status-list">
                <p>Loading status...</p>
            </div>
            <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <a href="/connect" style="color: #1877f2; text-decoration: none; font-weight: 600;">+ Link New WhatsApp Account</a>
            </div>
        </div>

        <div class="card">
            <h2>Send a Message</h2>
            <form id="sendMessageForm">
                <div class="form-group">
                    <label for="sender">Sender Identity (Account Name)</label>
                    <input type="text" id="sender" name="sender" placeholder="e.g. MyPersonalWhatsApp" required>
                </div>
                <div class="form-group">
                    <label for="contact">Contact Name or Group</label>
                    <input type="text" id="contact" name="contact" required>
                </div>
                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" name="message" rows="3" required></textarea>
                </div>

                <div id="suggestions-container"></div>
                
                <button type="button" id="generate-suggestions-btn" style="background-color: #42b72a;">Generate Suggestions</button>
                <button type="submit">Send Message</button>
            </form>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Conversation Log</h2>
                <select id="account-filter" style="width: auto;" onchange="fetchMessages()">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div id="messages">
                <p>No messages yet.</p>
            </div>
        </div>
    </div>

    <script>
        let currentMessages = [];

        async function fetchAccountStatus() {
            try {
                const response = await fetch('/api/account_status');
                const accounts = await response.json();
                const listDiv = document.getElementById('account-status-list');
                const filterSelect = document.getElementById('account-filter');
                const currentFilter = filterSelect.value;
                
                listDiv.innerHTML = '';
                
                // Keep "All Accounts" option
                filterSelect.innerHTML = '<option value="">All Accounts</option>';

                if (accounts.length === 0) {
                    listDiv.innerHTML = '<p>No accounts found.</p>';
                    return;
                }

                accounts.forEach(acc => {
                    const row = document.createElement('div');
                    row.className = 'account-row';
                    const statusClass = acc.status === 'online' ? 'status-online' : 'status-offline';
                    row.innerHTML = `
                        <div>
                            <span class="status-indicator ${statusClass}"></span>
                            <strong>${acc.account}</strong>
                        </div>
                        <small>Last seen: ${acc.last_seen}</small>
                    `;
                    listDiv.appendChild(row);

                    // Add to filter dropdown
                    const option = document.createElement('option');
                    option.value = acc.account;
                    option.innerText = acc.account;
                    filterSelect.appendChild(option);
                });
                
                // Restore selection
                filterSelect.value = currentFilter;

            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        document.getElementById('sendMessageForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const sender = document.getElementById('sender').value;
            const contact = document.getElementById('contact').value;
            const message = document.getElementById('message').value;

            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender, contact, message })
                });
                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Message sent successfully!');
                    document.getElementById('message').value = ''; 
                    document.getElementById('suggestions-container').innerHTML = ''; 
                }
            } catch (error) {
                alert('An error occurred while sending the message.');
                console.error(error);
            }
        });

        async function handleGenerateSuggestions() {
            const btn = document.getElementById('generate-suggestions-btn');
            const suggestionsContainer = document.getElementById('suggestions-container');
            btn.disabled = true;
            btn.innerText = 'Generating...';
            suggestionsContainer.innerHTML = '';

            try {
                const response = await fetch('/api/generate_suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation: currentMessages })
                });
                const suggestions = await response.json();
                
                suggestions.forEach(suggestionText => {
                    const suggestionBtn = document.createElement('button');
                    suggestionBtn.className = 'suggestion-btn';
                    suggestionBtn.innerText = suggestionText;
                    suggestionBtn.onclick = () => {
                        document.getElementById('message').value = suggestionText;
                    };
                    suggestionsContainer.appendChild(suggestionBtn);
                });

            } catch (error) {
                console.error('Error generating suggestions:', error);
                suggestionsContainer.innerHTML = '<p style="color: red;">Could not generate suggestions.</p>';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Generate Suggestions';
            }
        }

        document.getElementById('generate-suggestions-btn').addEventListener('click', handleGenerateSuggestions);

        async function fetchMessages() {
            try {
                const accountFilter = document.getElementById('account-filter').value;
                let url = '/api/messages';
                if (accountFilter) {
                    url += `?account=${encodeURIComponent(accountFilter)}`;
                }

                const response = await fetch(url);
                const messages = await response.json();
                currentMessages = messages; 
                const messagesDiv = document.getElementById('messages');
                
                if (messages.length === 0) {
                    messagesDiv.innerHTML = '<p>No messages yet.</p>';
                    return;
                }

                messagesDiv.innerHTML = ''; 
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    
                    msgDiv.innerHTML = `
                        <div class="message-meta">
                            <strong>${msg.sender || 'Unknown'}</strong> 
                            (${msg.chat_name || 'Chat'}) 
                            via <em>${msg.account || 'Unknown'}</em>
                            <span style="float:right">${msg.timestamp || ''}</span>
                        </div>
                        <div class="text">${msg.text || ''}</div>
                    `;
                    messagesDiv.appendChild(msgDiv);
                });
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        // Poll every 5 seconds
        setInterval(() => {
            fetchMessages();
            fetchAccountStatus();
        }, 5000);
        
        // Initial fetch
        fetchMessages();
        fetchAccountStatus();
    </script>
</body>
</html>